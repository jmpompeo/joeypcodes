---
const label = 'Toggle site theme';
---

<button
  type="button"
  class="flex h-10 w-10 items-center justify-center rounded-full border border-[var(--color-border)] bg-[var(--color-surface-alt)] text-lg text-[var(--color-text)] transition-colors duration-150 hover:border-[var(--color-accent)] focus-visible:border-[var(--color-accent)]"
  data-theme-toggle
  aria-label={label}
>
  <span aria-hidden="true" data-theme-icon>ðŸŒ™</span>
</button>

<script is:inline>
  const STORAGE_KEY = 'jp-theme-preference';
  const root = document.documentElement;
  const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

  const applyTheme = (theme, iconEl, toggleEl) => {
    if (theme === 'light') {
      root.classList.add('theme-light');
      iconEl.textContent = 'â˜€ï¸';
    } else {
      root.classList.remove('theme-light');
      iconEl.textContent = 'ðŸŒ™';
    }
    toggleEl.setAttribute('aria-pressed', theme === 'light' ? 'true' : 'false');
  };

  const resolveInitialTheme = () => {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored === 'light' || stored === 'dark') {
      return stored;
    }
    return mediaQuery.matches ? 'dark' : 'light';
  };

  const init = () => {
    const toggle = document.querySelector('[data-theme-toggle]');
    const icon = document.querySelector('[data-theme-icon]');
    if (!toggle || !icon) {
      return;
    }

    applyTheme(resolveInitialTheme(), icon, toggle);

    toggle.addEventListener('click', () => {
      const nextTheme = root.classList.contains('theme-light') ? 'dark' : 'light';
      applyTheme(nextTheme, icon, toggle);
      localStorage.setItem(STORAGE_KEY, nextTheme);
    });

    mediaQuery.addEventListener('change', (event) => {
      if (localStorage.getItem(STORAGE_KEY)) {
        return;
      }
      const preferred = event.matches ? 'dark' : 'light';
      applyTheme(preferred, icon, toggle);
    });
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init, { once: true });
  } else {
    init();
  }
</script>
