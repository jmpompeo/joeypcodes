---
import BaseLayout from '../layouts/BaseLayout.astro';
import PostCard from '../components/PostCard.astro';
import { getCollection } from 'astro:content';

const postEntries = (await getCollection('posts'))
  .filter(({ data }) => !data.draft)
  .sort((a, b) => {
    const aDate = a.data.published ?? new Date(0);
    const bDate = b.data.published ?? new Date(0);
    return bDate.getTime() - aDate.getTime();
  });

const posts = postEntries.map((entry) => ({
  slug: entry.slug,
  title: entry.data.title ?? 'Untitled Post',
  description: entry.data.description ?? 'Details coming soon.',
  published: entry.data.published ?? new Date(0),
  tags: Array.isArray(entry.data.tags) ? entry.data.tags : [],
}));

const tags = Array.from(new Set(posts.flatMap((post) => post.tags))).sort((a, b) =>
  a.localeCompare(b)
);
---

<BaseLayout
  title="Technical notes and tutorials"
  description="Exploring Azure automation, .NET engineering, and DevOps delivery through practical guides and case studies."
>
  <section class="space-y-10">
    <header class="space-y-4">
      <p class="text-xs uppercase tracking-[0.3em] text-primary">Blog</p>
      <h1 class="text-4xl font-bold text-white md:text-5xl">Latest writing</h1>
      <p class="max-w-prose text-text-light/80">
        Articles focus on applying Azure, CI/CD, and automation in the real world. Tag filters are a planned enhancement â€”
        for now, browse the topics that interest you most.
      </p>
    </header>

    {tags.length > 0 ? (
      <div class="flex flex-wrap gap-3">
        {tags.map((tag) => (
          <button
            type="button"
            class="cursor-default rounded-full border border-white/10 bg-surface-dark/70 px-4 py-2 text-xs uppercase tracking-wide text-text-light/70"
            aria-disabled="true"
          >
            {tag}
          </button>
        ))}
      </div>
    ) : (
      <p class="text-sm text-text-light/60">Posts will be tagged as new articles are published.</p>
    )}

    {posts.length > 0 ? (
      <div class="grid gap-6 md:grid-cols-2">
        {posts.map((post) => (
          <PostCard post={post} />
        ))}
      </div>
    ) : (
      <p class="rounded-2xl border border-dashed border-white/10 bg-surface-dark/60 p-6 text-sm text-text-light/70">
        No posts are published yet. Check back soon for new articles.
      </p>
    )}
  </section>
</BaseLayout>
